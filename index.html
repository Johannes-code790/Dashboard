<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company IoT Dashboard</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; align-items: center; }
        header { background: white; width: 100%; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; width: 90%; max-width: 1000px; margin-top: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .label { color: #666; font-size: 0.8em; text-transform: uppercase; }
        .value { font-size: 2.5em; font-weight: bold; margin: 10px 0; color: #333; }
        .unit { font-size: 0.5em; color: #999; }
        #status { font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <h1>Company Sensor Monitor</h1>
    <div id="status" style="color: #e67e22;">‚è≥ Verbinde...</div>
</header>

<div class="container">
    <div class="card">
        <div class="label">Temperatur</div>
        <div class="value" style="color: #ff5722;"><span id="temp">--.-</span><span class="unit">¬∞C</span></div>
    </div>
    <div class="card">
        <div class="label">Feuchtigkeit</div>
        <div class="value" style="color: #2196f3;"><span id="hum">--</span><span class="unit">%</span></div>
    </div>
    <div class="card">
        <div class="label">CO2</div>
        <div class="value" style="color: #4caf50;"><span id="co2">----</span><span class="unit">ppm</span></div>
    </div>
    <div class="card">
        <div class="label">TVOC</div>
        <div class="value" style="color: #9c27b0;"><span id="tvoc">----</span><span class="unit">ppb</span></div>
    </div>
</div>

<script>
    // 1. ID aus URL holen (?id=123456)
    const urlParams = new URLSearchParams(window.location.search);
    const deviceId = urlParams.get('id');

    // 2. Verbindungsdaten
    const brokerUrl = 'wss://g306b096.ala.eu-central-1.emqxsl.com:8084/mqtt';
    const options = {
        username: 'web_user',        // Dein EMQX-Username
        password: 'web_password123', // Dein EMQX-Passwort
        clean: true
    };

    if (!deviceId) {
        document.getElementById('status').innerText = "üî¥ FEHLER: Keine ?id= in der URL angegeben!";
    } else {
        // KORRIGIERTES TOPIC
        const topic = `esp32-${deviceId}/sensor`;
        
        const client = mqtt.connect(brokerUrl, options);

        client.on('connect', () => {
            document.getElementById('status').innerText = `üü¢ ONLINE - Ger√§t: ${deviceId}`;
            document.getElementById('status').style.color = "green";
            client.subscribe(topic);
        });

        client.on('message', (t, message) => {
            try {
                // Verarbeitet das JSON-Format
                const data = JSON.parse(message.toString());
                if(data.temp !== undefined) document.getElementById('temp').innerText = data.temp;
                if(data.hum !== undefined)  document.getElementById('hum').innerText = data.hum;
                if(data.co2 !== undefined)  document.getElementById('co2').innerText = data.co2;
                if(data.tvoc !== undefined) document.getElementById('tvoc').innerText = data.tvoc;
            } catch (e) {
                console.log("Rohdaten empfangen:", message.toString());
            }
        });

        client.on('error', (err) => {
            document.getElementById('status').innerText = "üî¥ VERBINDUNGSFEHLER";
            console.error(err);
        });
    }
</script>
</body>
</html>
